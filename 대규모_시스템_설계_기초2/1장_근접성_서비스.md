# 2. 개략적인 설계안

**API**

  API 는 restful 하게 설계하면 됩니다.

**데이터 모델**

  근접성 서비스는 읽기 연산이 쓰기 연산보다 더 많이 비율로 수행됩니다. 데이터 스키마는 두 개의 핵심 테이블이 있는데, 하나는 사업장 상세 정보의 business 테이블이고 다른 하나는 지리적 위치 색인 테이블 입니다.

## 2.1 개략적인 설계

![image-20240409225642322](images/1장_근접성_서비스/image-20240409225642322.png)

  서비스는 사업자 서비스와 LBS 가 있습니다. LBS 는 주어진 위치와 반경 정보로 주변 사업장을 검색합니다. 사업자 서비스는 사업장 정보에 대한 CRUD 를 담당합니다. 서비스는 stateless 로, 확장에 용이합니다. DB 는 클러스터로 구성되어있으며 복제에 레이턴시가 일부 있을 수 있지만 크게 문제되지 않습니다.

## 2.2 주변 사업장 검색 알고리즘

**방안 1 : 2차원 검색**

  주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법입니다. 이 방법은 위도와 경도의 교집합을 구해야 하기 때문에 각 집합에 속한 데이터 양 때문에 효율적일 수가 없습니다.

  이러한 문제는 2차원 데이터를 한 차원에 대응시켜 해결해야 합니다. 크게 지리적 정보에 색인을 만드는 방법은 두 종류입니다.

![image-20240415213920575](images/1장_근접성_서비스/image-20240415213920575.png)

  개략적인 아이디어는 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 하는 것입니다.

**방안 2 : 균등 격자**

![image-20240415214905275](images/1장_근접성_서비스/image-20240415214905275.png)

  지도를 작은 격자 또는 구획으로 나누는 단순한 접근법입니다. 이 방법은 단순하지만 사업장 분포가 균등하지 않다는 문제가 있습니다.

**방안 3 : 지오해시**

![image-20240415215238098](images/1장_근접성_서비스/image-20240415215238098.png)

  지오해시는 2차원의 위도 경도 데이터를 1차원의 문자열로 변환합니다. 그리고 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해갑니다. 지오해시는 해시값의 공통 접두어(prefix) 가 긴 격자들이 서로 더 가깝게 놓이도록 보장합니다.

  하지만 그 역은 참이 아닙니다. 아주 가까운 두 위치가 어떤 공통 접두어도 갖지 않을 수도 있습니다. 또한 공통 접두어 길이는 길지만 서로 다른 격자에 놓일 수도 있습니다.

**방안 4 : 쿼드트리**

![image-20240415220452546](images/1장_근접성_서비스/image-20240415220452546.png)

  쿼드트리는 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 분할합니다. 예를 들어 격자의 사업장 수가 100 이하가 될 때까지 분할합니다.

  쿼드트리를 사용한다는 것은 질의에 답하는 데 사용될 트리 구조를 메모리 안에 만드는 것입니다. 쿼드트리를 전부 저장하는 데 필요한 메모리는 필요한 정보에 따라 다르지만 2GB 이하로, 메모리를 많이 잡아먹지 않습니다. 또한 쿼드트리를 구축하는데 소요되는시간은 몇 분 정도 걸릴 수 있습니다.

**방안 5 : 구글 S2**

​    쿼드트리와 마찬가지로 메모리 기반입니다. 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용하여 1차원 색인화하는 방안입니다. 그리고 힐베르트 곡선 상에서 인접한 두 지점은 색인화 이후 1차원 공간 내에서도 인접한 위치에 있습니다. 

![image-20240415221819321](images/1장_근접성_서비스/image-20240415221819321.png)

# 3. 상세 설계

  더 살펴봐야 할 부분은 아래와 같습니다.

- 데이터베이스 규모 확장
- 캐시(cache)
- 지역(region) 및 가용성 구역 (availability zone)
- 시간대 또는 사업장 유형에 따른 검색
- 최종 아키텍처 다이어그램

## 3.1 데이터베이스 규모 확장성

  사업장 테이블과 지리 정보 색인 테이블이 있습니다. 이 중 사업장 테이블은 사업장 ID 로 샤딩하기 쉽습니다. 지리 정보 색인 테이블을 구성하는 벙법은 두 가지입니다.

- 방안 1: 각각의 지오해시에 연결되는 모든 사업장 ID 를 JSON 배열로 만들어 같은 열에 저장. 특정한 지오해시에 속한 모든 사업장 ID 가 한 열에 보관됨
- 방안 2: 같은 지오해시에 속한 사업장 ID 각각을 별도 열로 저장. 사업장마다 한 개의 레코드 필요

  사업장 정보 갱신 시 방안 1 에서는 일단 JSON 배열을 읽은 다음 갱신할 사업장 ID 를 찾아야 하고, 락을 사용해야 합니다. 반면에 방안 2 의 경우에는 지오해시와 사용자 ID 컬럼을 복합키로 사용하면 락을 사용할 필요가 없습니다. 따라서 방안 2 가 추천됩니다.

  지리 정보 색인 테이블의 규모를 확장하기 위해서는 읽기 복제본을 생성하거나, 샤딩을 적용하는 것입니다. 하지만 지오해시 테이블은 샤딩이 까다로우므로 데이터의 크기를 고려해 선택해야 합니다.

## 3.2 캐시

**캐시 키**

  사용자의 위치 정보는 오차가 날 수 있고 계속 업데이트되므로 캐시 키로 적절하지 않습니다. 지오해시나 쿼드트리에서는 같은 격자 내 모든 사업장이 같은 해시 값을 갖도록 만들 수 있기 때문에 해당 값이 적절합니다.

**캐시 데이터 유형**

  캐시에는 지오해시 키로 해당 격자 내의 사업장 ID 목록을 저장하고, 사업장 ID 로는 사업장 정보를 저장합니다. 

**지역 및 가용성 구역**

  위치 기반 서비스를 여러 지역과 가용성 구역에 설치한다면 사용자와 시스템 사이의 물리적 거리를 최소한으로 줄일 수 있고, 트래픽을 인구에 따라 고르게 분산할 수 있습니다.

**최종 아키텍처 다이어그램**

![image-20240415223825998](images/1장_근접성_서비스/image-20240415223825998.png)

  
