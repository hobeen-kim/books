![image-20240428122927489](images/12장_로드밸런서/image-20240428122927489.png)

  로드밸런서는 가상 IP 주소인 VIP 를 가지고 있으며, 실제 서버들의 IP 가 VIP 에 바인딩되어 있음. 로드 밸런서에서 부하 분산 그룹을 만들 때 IP 주소뿐만 아니라 서비스 포트까지 지정해서 만들기 때문에 로드 밸런서를 L4 스위치라고 함.

**헬스 체크**

- ICMP : ping 으로 헬스 체크. 잘 사용하지 않음
- TCP 서비스 포트 : SYN, ACK 로 확인
- TCP 서비스 포트 (Half Open) : 정상적인 TCP 연결보다 빨리 헬스 체크 세션을 끊기 위해 SYN -> SYN/ACK 이후에 ACK 대신 RST 를 보내 세션을 끊음
  - ![image-20240428123337000](images/12장_로드밸런서/image-20240428123337000.png)
- HTTP 상태 코드 : 3way 핸드셰이크 이후 HTTP 를 요청해 200 OK 르 응답하는지 확인
- 콘텐츠 확인(문자열 확인) : 요청에 대한 결과값으로 상태확인

**헬스 체크 주기와 타이머**

- 주기 : 헬스 체크 패킷을 보내는 주기
- 응답 시간 : 헬스 체크 패킷을 보내고 응답을 기다리는 시간
- 시도 횟수 : 헬스 체크 실패 시 최대 시도 횟수
- 탕미아웃 :  헬스 체크 실패 시 최대 대기 시간
- 서비스 다운 시의 주기 (dead interval) : 서비스 다운 시의 헬스 체크 주기

![image-20240428125005935](images/12장_로드밸런서/image-20240428125005935.png)

# 부하 분산 알고리즘

![image-20240428125201197](images/12장_로드밸런서/image-20240428125201197.png)

# 로드 밸런서의 구성 방식

![image-20240428125816181](images/12장_로드밸런서/image-20240428125816181.png)

- 원암 구성 : 로드 밸런서가 중간 스위치 옆에 연결되는 구성. 서버로 가는 트래픽이 모두 로드밸런서를 경유하지 않아도 됨
  - 부하분산을 이용할 때는 로드밸런서를 거치고, 그렇지 않으면 로드밸런서를 거치지 않음
  - 로드밸런서 부하 감소 및 장애 영향도를 줄임
- 인라인 구성 : 서버로 가는 경로 상에 로드 밸런서가 연결
  - 구성이 직관적이고 이해하기 쉬움

# 로드밸런서 동작 모드

## 트랜스패런트 모드

  로드밸런서가 서비스하는 VIP 주소와 실제 서버가 동일한 네트워크를 사용해 로드밸런서가 OSI 2계층 스위치처럼 동작하는 구성. 인라인 구성과 원암 구성이 둘 다 가능하나 원암 구성에는 응답 트래픽 경로 부분이 문제가 될 수 있으므로 Source NAT 이 필요함

![image-20240429214203429](images/12장_로드밸런서/image-20240429214203429.png)

  요청할 때는 로드밸런서를 통과할 때 목적지 IP 와 목적지 MAC 이 변경됨. 로드밸런서와 목적지 서버가 동일한 네트워크 대역이므로 출발지 MAC 주소는 변경되지 않음

![image-20240429214354080](images/12장_로드밸런서/image-20240429214354080.png)

  반대로 응답할 때는 로드밸런서를 지나면서 출발지 IP 가 변경되지만 목적지 MAC 주소는 변경되지 않음. 목적지 MAC 주소가 이미 게이트웨이의 MAC 주소를 갖고 있기 때문임

![image-20240429214531684](images/12장_로드밸런서/image-20240429214531684.png)

## 라우티드 모드

  로드밸런서가 라우팅 역할을 수행하면서, 사용자 방향과 서버 방향의 네트워크를 라우팅으로 연결. 라우터와 같이 맥주소가 변경됨.

![image-20240429220145501](images/12장_로드밸런서/image-20240429220145501.png)

## DSR 모드

  DSR (Direct Server Return) 은 명칭 그대로 사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드 밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드. 로드 밸런서 부하가 감소하는 효과가 있지만 문제가 발생했을 때 문제 확인이 어려움

![image-20240429224805748](images/12장_로드밸런서/image-20240429224805748.png)

- 사용자는 서비스 IP인 VIP 주소 10.10으로 서비스를 요청
- 로드 밸런서는 목적지 IP를 VIP 주소로 두고 목적지 서버의 MAC 주소만 변경해 실제 서버로 전송
- 실제 서버에서는 루프백 인터페이스에 VIP와 동일한 IP 주소가 설정되어 있고 목적지 IP가 이 루프백 IP와 동일한 경우에도 패킷을 수신

 ![image-20240429224913334](images/12장_로드밸런서/image-20240429224913334.png)

- DSR 모드의 응답은 로드 밸런서가 개입하지 않으므로 로드 밸런서를 사용하지 않는 일반 패킷과 유사하게 전달됨
- 다만 출발지 IP 가 서버의 인터페이스 IP 주소가 아닌 루프백 인터페이스 IP 주소임
